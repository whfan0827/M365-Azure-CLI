# Import Microsoft Graph module
Import-Module Microsoft.Graph

# Login with admin account (supports MFA)
Connect-MgGraph -Scopes "User.Read.All"

# Get all users with UserPrincipalName and OnPremisesImmutableId
$allUsers = Get-MgUser -All -Property UserPrincipalName,OnPremisesImmutableId

# Display UserPrincipalName and OnPremisesImmutableId in table
$allUsers | Select-Object UserPrincipalName, OnPremisesImmutableId | Format-Table -AutoSize

# Export UserPrincipalName and OnPremisesImmutableId to CSV file
$allUsers | Select-Object UserPrincipalName, OnPremisesImmutableId | Export-Csv -Path "C:\Export\AzureAD_Users_ImmutableId.csv" -NoTypeInformation -Encoding UTF8

# Show all users with empty OnPremisesImmutableId
$allUsers | Where-Object { !$_.OnPremisesImmutableId } | Select-Object UserPrincipalName

